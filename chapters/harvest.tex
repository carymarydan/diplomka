\label{sec:harvest}

OAI-PMH\footnote{OAI-PMH (Open Archives Initiative Protocol for Metadata Harvesting) je protokol umožòující sklízení metadatových záznamù z digitálních repozitáøù, který vytvoøila Iniciativa otevøených archivù (Open Archives Initiative, OAI) za úèelem zlepšení a usnadnìní interoperability mezi jednotlivými digitálními archivy. První verze protokolu vznikla v CERNu v roce 2001, stabilní verze 2.0 byla vydána o rok pozdìji. \cite{wiki.oai}}, zkratka pro Open Archives Initiative Protocol for Metadata Harvesting, je nízko-bariérový mechanizmus interoperability pro repositáøe. Repositáø vybavený OAI-PMH pøes tento protokol vystavuje strukturovaná metadata a stává se z nìj tak poskytovatel dat. Poskytovatel služeb potom pøes OAI-PMH posílá požadavky na sklízení tìchto metadat. OAI-PMH se skládá ze sady šesti služeb (Identify, ListMetadataFormats, ListSets, ListIdentifiers, ListRecords, GetRecord), které jsou spouštìny v rámci protokolu HTTP. \cite{oai.pmh}

VuFind je tímto protokolem vybaven a v NTK je využit pro každodenní aktualizaci katalogu sklízením zmìn v záznamech integrovaného knihovnického systému Aleph.


Pøed samotným sklízením dat z externích zdrojù do VuFindu, potažmo Solr indexu, je tøeba provést patøièná nastavení. Pro tyto úèely se v koøenovém adresáøi systému nachází složka \texttt{harvest}, která obsahuje potøebné skripty. Stejnì jako v pøípadì importu dat nebo nastavení konfiguraèních souborù i zde se pro lokální požadavky knihovny vytváøí alternativní složka \texttt{harvest} v lokálním adresáøi \texttt{local} odkud se naèítají informace jako první. Pokud zde nìjaké nastavení chybí, aplikuje se konfigurace z nadøazeného adresáøe výchozího. V pøípadì NTK se v umístìní
\begin{verbatim}
/var/www/vufind/local/harvest
\end{verbatim}
nachází upravená kopie souboru \texttt{oai.ini}, kde je nastaveno jméno adresáøe, do kterého se data sklízí. Tím je podadresáø \texttt{katalog\_ntk-update}. Dále je zde uvedena URL adresa zdroje, z nìhož se data sklízí. Tou je \texttt{http://aleph.techlib.cz/OAI}. Dalším parametrem k nastavení je \texttt{set}, což je identifikátor sady urèené ke sklízení, kterou je NTK. Parametr \texttt{metadataPrefix} je nastaven na MARC21, protože je požadováno pøijímat data v tomto formátu. K dispozici je i další metadatový formát DublinCore, který se v NTK nepoužívá. Dále je nastavena granularita data na formát \uv{YYYY-MM-DDThh:mm:ssZ}, podle níž se pøi sklízení dat porovnává èasová znaèka záznamu a rozhoduje se tak, jestli záznam podléhá sklízení nebo jeho datum zmìny je starší a pravdìpodobnì už byl sklizen. Nastavení souboru pro zapisování identifikátorù sklizených záznamù \texttt{harvest.log} je aktivní, i když volitelné.

V adresáøi \texttt{katalog\_ntk-update} pro sklízení dat se nachází jeden dùležitý soubor, kterým je \texttt{last\_harvest.txt}. Do nìho se zapisuje, potažmo pøepisuje èasové razítko posledního procesu sklízení. Pøi následném sklízení je dle tohoto data jasné, které záznamy byly už sklizeny a které se tedy mají sklidit. Sklízené záznamy se ukládají jednotlivì do~XML souborù a potom, co jsou dále zpracovány, tedy importovány do indexu nebo z indexu vymazány, pøesouvají se do podadresáøe \texttt{processed}.
\cite{vufind.oai}

V NTK konkrétní požadavkem na sklízení dat pøes protokol OAI-PMH vypadá takto:
\begin{lstlisting}
http://aleph.techlib.cz/OAI?verb=ListIdentifiers&from=2016-07-06&metadataPrefix=marc21&set=NTK
\end{lstlisting}
Odpovìd ve formátu XML obsahuje maximálnì 30 záznamù. Na konci tohoto souboru je obvykle tag \texttt{<resumptionToken>}, ve kterém je udán øetìzec, podle nìhož se dalším dotazem na OAI-PMH získá pokraèování seznamu identifikátorù se zmìnìnými údaji. Tento dotaz vypadá takto:
\begin{lstlisting}
http://aleph.techlib.cz/OAI?verb=ListIdentifiers&resumptionToken=201607070737134999999999999999NTK:NTK_21
\end{lstlisting}
Èást odpovìdi na OAI-PMH požadavek mùže vypadat takto:
\begin{lstlisting}
<OAI-PMH xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
 <responseDate>2016-07-09T15:02:56Z</responseDate>
 <request verb="ListIdentifiers" from="2016-07-06" metadataPrefix="marc21" set="NTK">http://aleph.techlib.cz/OAI</request>
 <ListIdentifiers>
   <header>
     <identifier>oai:aleph.techlib.cz:STK01-000969194</identifier>
     <datestamp>2016-07-07T06:09:05Z</datestamp>
     <setSpec>NTK</setSpec>				
   </header>
   <header>
     <identifier>oai:aleph.techlib.cz:STK01-000618216</identifier>
	 <datestamp>2016-07-07T06:25:40Z</datestamp>
	 <setSpec>NTK</setSpec>
   </header>
\end{lstlisting}

